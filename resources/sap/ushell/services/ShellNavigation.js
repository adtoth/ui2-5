// Copyright (c) 2013 SAP AG, All Rights Reserved
jQuery.sap.require("sap.ui.thirdparty.signals");jQuery.sap.require("sap.ui.thirdparty.hasher");jQuery.sap.require("sap.ui.core.routing.HashChanger");jQuery.sap.declare("sap.ushell.services.ShellNavigation");(function(){"use strict";jQuery.sap.declare("sap.ushell.services.ShellNavigation");sap.ui.core.routing.HashChanger.extend("sap.ushell.services.ShellNavigationHashChanger",{constructor:function(){sap.ui.core.routing.HashChanger.apply(this);this.priv_initializedByShellNav=false;this.privfnShellCallback=null;this.privappHashPrefix="&/";this.privhashPrefix="#";this.privgetCurrentShellHash=function(){var r=this.privsplitHash(hasher.getHash());if(!r){return hasher.getHash()}return this.privhashPrefix+r.shellPart};this.privgetCurrentShellHashNoHash=function(){var r=this.privsplitHash(hasher.getHash());if(!r){return hasher.getHash()}return r.shellPart};this.privconstructHash=function(a){return this.privgetCurrentShellHash()+a};this.privconstructShellHash=function(s){return sap.ushell.Container.getService("URLParsing").constructShellHash(s)};this.privsplitHash=function(h){if(h===undefined||h===null||h===""){return{}}var s=sap.ushell.Container.getService("URLParsing").parseShellHash(h);return{shellPart:(s&&this.privstripLeadingHash(this.privconstructShellHash(s)))||null,appSpecificRoute:(s&&s.appSpecificRoute)||null}};this.privsetHash=function(h,w){hasher.prependHash="";h=this.privstripLeadingHash(h);if(w===undefined){w=true}if(w){sap.ui.core.routing.HashChanger.prototype.setHash.apply(this,[h])}else{sap.ui.core.routing.HashChanger.prototype.replaceHash.apply(this,[h])}};this.privstripLeadingHash=function(h){if(h[0]==='#'){return h.substring(1)}return h};this.hrefForExternal=function(a){return"#"+encodeURI(this.privstripLeadingHash(this.privhrefForExternalNoEnc(a)))};this.privhrefForExternalNoEnc=function(a){var r;if(a===undefined){return"#"+this.privgetCurrentShellHashNoHash()}if(a&&a.target&&(typeof a.target.semanticObject==="string"||typeof a.target.shellHash==="string")){r="#"+this.privconstructShellHash(a);return r}return"#"+this.privgetCurrentShellHashNoHash()};this.hrefForAppSpecificHash=function(a){return"#"+encodeURI(this.privconstructHash(this.privappHashPrefix+a))};this.toExternal=function(a){var h=this.privhrefForExternalNoEnc(a);this.privsetHash(h)};this.toAppHash=function(a,w){var h=this.privconstructHash(this.privappHashPrefix+a);this.privsetHash(h,w)}}});sap.ushell.services.ShellNavigationHashChanger.prototype.initShellNavigation=function(){if(this.priv_initializedByShellNav){jQuery.sap.log.info("initShellNavigation already called on this ShellNavigationHashChanger instance.");return false}hasher.changed.add(this.treatHashChanged,this);if(!hasher.isActive()){hasher.initialized.addOnce(this.treatHashChanged,this);hasher.init()}else{this.treatHashChanged(hasher.getHash())}this.priv_initializedByShellNav=true;return true};sap.ushell.services.ShellNavigationHashChanger.prototype.init=function(){if(this.priv_initialized){jQuery.sap.log.info("init already called on this ShellNavigationHashChanger instance.");return false}var n=this.privsplitHash(hasher.getHash()),a=(n.appSpecificRoute||"  ").substring(2);this.fireEvent("hashChanged",{newHash:a});this.priv_initialized=true;return true};sap.ushell.services.ShellNavigationHashChanger.prototype.treatHashChanged=function(n,o){var a,O,N,b;N=this.privsplitHash(n);b=this.privsplitHash(o);if(N.shellPart===b.shellPart&&(o!==undefined)){a=(N.appSpecificRoute||"  ").substring(2);O=(b.appSpecificRoute||"  ").substring(2);this.fireEvent("hashChanged",{newHash:a,oldHash:O});return}this.fireEvent("shellHashChanged",{newShellHash:N.shellPart,newAppSpecificRoute:N.appSpecificRoute,oldShellHash:b.shellPart});this.privfnShellCallback(N.shellPart,N.appSpecificRoute,b.shellPart)};sap.ushell.services.ShellNavigationHashChanger.prototype.setHash=function(h){this.toAppHash(h,true)};sap.ushell.services.ShellNavigationHashChanger.prototype.replaceHash=function(h){this.toAppHash(h,false)};sap.ushell.services.ShellNavigationHashChanger.prototype.getHash=function(){return this.getAppHash()};sap.ushell.services.ShellNavigationHashChanger.prototype.getAppHash=function(){var n=this.privsplitHash(hasher.getHash()),a=(n.appSpecificRoute||"  ").substring(2);return a};sap.ushell.services.ShellNavigationHashChanger.prototype.destroy=function(){hasher.changed.remove(this.fireHashChanged);sap.ui.core.routing.HashChanger.prototype.destroy.apply(this,arguments)};function S(){this.hashChanger=new sap.ushell.services.ShellNavigationHashChanger();this.hrefForExternal=function(a){return this.hashChanger.hrefForExternal(a)};this.hrefForAppSpecificHash=function(a){return this.hashChanger.hrefForAppSpecificHash(a)};this.toExternal=function(a){this.hashChanger.toExternal(a)};this.toAppHash=function(a,w){this.hashChanger.toAppHash(a,w)};this.init=function(s){hasher.prependHash="";sap.ui.core.routing.HashChanger.replaceHashChanger(this.hashChanger);this.hashChanger.privfnShellCallback=s;this.hashChanger.initShellNavigation();return this}}sap.ushell.bootstrap=sap.ushell.bootstrap||function(p){};sap.ushell.services.ShellNavigation=new S()}());
