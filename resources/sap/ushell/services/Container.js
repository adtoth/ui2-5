// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.services.Container");jQuery.sap.require("sap.ushell.utils");jQuery.sap.require("sap.ushell.System");function c(n,s,p){var a="sap.ushell.adapters."+s.getPlatform()+"."+n+"Adapter";jQuery.sap.require(a);return new(jQuery.sap.getObject(a))(s,p)}function C(a){var s=new sap.ushell.utils.Map(),r={};this.createRenderer=function(R){var b,o;if(!R){throw new Error("Missing renderer name")}b=R.indexOf(".")<0?"sap.ushell.renderers."+R+".Renderer":R;jQuery.sap.require(b);o=new(jQuery.sap.getObject(b))();if(o instanceof sap.ui.core.UIComponent){o=new sap.ui.core.ComponentContainer({component:o,height:"100%",width:"100%"})}if(!(o instanceof sap.ui.core.Control)){throw new Error("Unsupported renderer type for name "+R)}return o};this.getLogonSystem=function(){return a.getSystem()};this.getUser=function(){return a.getUser()};this.getService=function(S,p){var o={},m="sap.ushell.services."+S,k=m+"/"+(p||""),b,d,e;function f(g){var D=new jQuery.Deferred();if(!g){throw new Error("Missing system")}D.resolve(c(S,g,p));sap.ushell.Container.addRemoteSystem(g);return D.promise()}if(!S){throw new Error("Missing service name")}if(S.indexOf(".")>=0){throw new Error("Unsupported service name")}if(!s.containsKey(k)){jQuery.sap.require(m);b=jQuery.sap.getObject(m);if(b.hasNoAdapter===true){d=new b(o,p)}else{e=c(S,a.getSystem(),p);o.createAdapter=f;d=new b(e,o,p)}s.put(k,d);return d}return s.get(k)};this.addRemoteSystem=function(R){if(Object.prototype.hasOwnProperty.call(r,R.getAlias())){jQuery.sap.log.debug("Remote system "+JSON.stringify(R)+"already added!",null,"sap.ushell.Container");return}r[R.getAlias()]=R;jQuery.sap.log.debug("Added "+JSON.stringify(R),null,"sap.ushell.Container")};this.logout=function(){var d=new jQuery.Deferred(),R=[];function b(o){var D=new jQuery.Deferred(),p;p=o.getService("PageBuilding").getFactory().getPageBuildingService();p.readAllCatalogsForUser("type eq 'H'",function(e){var f=e.results;if(f){f.forEach(function(g){o.addRemoteSystem(new sap.ushell.System({alias:g.systemId,platform:"hana"}))})}D.resolve()},function(e){jQuery.sap.log.error("Reading HANA catalogs failed: "+e,null,"sap.ushell.Container");D.reject()});return D.promise()}b(this).always(function(){Object.keys(r).forEach(function(A){R.push(c("Container",r[A]).logout(false))});jQuery.when.apply(jQuery,R).done(function(){a.logout(true);r={};d.resolve()})});return d.promise()}}sap.ushell.bootstrap=function(p){var a;if(sap.ushell.Container!==undefined){throw new Error("Cannot initialize twice")}sap.ushell.Container=null;if(typeof window["sap.ushell.bootstrap.callback"]==="function"){setTimeout(window["sap.ushell.bootstrap.callback"])}a=c("Container",new sap.ushell.System({alias:"",platform:p}));return a.load().done(function(){sap.ushell.Container=new C(a)})}}());
