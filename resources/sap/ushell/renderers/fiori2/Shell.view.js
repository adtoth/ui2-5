//Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ushell.renderers.fiori2.launchpad.DashboardManager");jQuery.sap.require("sap.ushell.touchSupport");sap.ui.jsview("sap.ushell.renderers.fiori2.Shell",{createContent:function(c){var p=function(i,m,n){return i?n:m},s=function(i,m){return sap.ui.getCore().byId(m.getObject())},S=function(m,n){if(n){jQuery.each(n,function(i,v){sap.ui.getCore().byId(v).toggleStyleClass("sapUICurtainPaneVisible",!!m)})}return!!m},C=new sap.ui.unified.ShellHeadItem({id:"configBtn",tooltip:{parts:["/currentState/showPane","i18n>showGrpsBtn_tooltip","i18n>hideGrpsBtn_tooltip"],formatter:p},icon:sap.ui.core.IconPool.getIconURI("menu2"),selected:{path:"/currentState/showPane"},press:[c.togglePane,c]}),h=new sap.ui.unified.ShellHeadItem({id:"homeBtn",title:"Home",tooltip:"{i18n>homeBtn_tooltip}",icon:sap.ui.core.IconPool.getIconURI("home"),press:[c.navigateToHome,c]}),b=new sap.ui.unified.ShellHeadItem({id:"backBtn",title:"Back",tooltip:"{i18n>backBtn_tooltip}",icon:sap.ui.core.IconPool.getIconURI("nav-back"),press:[c.navigateToHome,c]}),l=new sap.ushell.ui.footerbar.LogoutButton("logoutBtn",{iconFirst:false}).addStyleClass("sapUshellLogoutButton"),u=new sap.ui.unified.Shell({id:"shell",fullHeightContent:true,showPane:{path:"/currentState/showPane"},headItems:{path:"/currentState/headItems",factory:s},headEndItems:{path:"/currentState/headEndItems",factory:s},paneContent:{path:"/currentState/paneContent",factory:s},headerHiding:{path:"/currentState/headerHiding"}}),o=new sap.m.SearchField("sf",{width:"100%",placeholder:"{i18n>search}",showMagnifier:false,visible:{path:"/searchAvailable"},value:{path:"/searchTerm"}}),a=new sap.m.SearchField("sfOverlay",{width:"100%",placeholder:"{i18n>search}",showMagnifier:false,visible:{path:"/searchAvailable"},value:{path:"/searchTerm"}}),d=new sap.ui.unified.ShellOverlay("shellOverlay",{search:a,content:{path:"/currentState/curtainContent",factory:s},shell:u,closed:[c.onCurtainClose,c]}),H=sap.ui.view({id:"searchHistoryScreen",viewName:"sap.ushell.renderers.fiori2.search.HistoryScreen",type:sap.ui.core.mvc.ViewType.JS}),e=sap.ui.view({id:"searchResultsView",viewName:"sap.ushell.renderers.fiori2.search.SearchResults",type:sap.ui.core.mvc.ViewType.JS}),f=sap.ui.view({id:"searchSuggestionsView",viewName:"sap.ushell.renderers.fiori2.search.SearchSuggestions",type:sap.ui.core.mvc.ViewType.JS}),g=new sap.m.Page({id:"searchResultPage",showHeader:false,content:[f.clone(),e]}),D=new sap.ushell.renderers.fiori2.launchpad.DashboardManager("dashboardMgr",{model:c.getModel()}),j=this.pageFactory("dashboardPage",D.getDashboardView(),!jQuery.device.is.desktop),G=this.pageFactory("groupListPage",D.getGroupListView(),!jQuery.device.is.desktop),k=this.pageFactory("shellPage",u);this.lastSearchTerm="";this.initNavContainer(c);this.pageFactory("searchHistoryPage",[f,H]);this.pageFactory("searchFilterPage",[]);o.addEventDelegate({onfocusin:function(E){if(!d.isActive()){setTimeout(jQuery.proxy(function(){if(o.getValue().length===0||this.lastSearchTerm.length===0){sap.ui.getCore().getEventBus().publish("openHistoryScreen");jQuery.proxy(c.switchViewState("historyScreen",true),c)}else{jQuery.proxy(c.switchViewState("searchResults",true),c)}},this),0)}}},this);a.addEventDelegate({onfocusin:function(E){var i=a.getValue().length,m=a.$().find("input")[0],r;if(m.setSelectionRange){m.setSelectionRange(i,i)}else if(m.createTextRange){r=m.createTextRange();r.collapse(true);r.moveEnd('character',i);r.moveStart('character',i);r.select()}}});a.attachSearch(function(E){this.lastSearchTerm=E.getParameter("query");if(E.getParameter("query").length>0){clearTimeout(this.liveSearchTimeout);jQuery.proxy(c.switchViewState("searchResults"),c);var i=sap.ui.getCore().getEventBus();i.publish("search",{searchTerm:E.getParameter("query"),dataSource:E.getParameter("dataSource"),categorySuggested:E.getParameter("categorySuggested")})}},this);a.attachLiveChange(function(E){var i=E.getParameter("newValue");if(o.getValue().length===0){sap.ui.getCore().getEventBus().publish("openHistoryScreen");if(!d.isActive()){jQuery.proxy(c.switchViewState("historyScreen",true),c)}else{jQuery.proxy(c.switchViewState("historyScreen"),c)}}clearTimeout(this.liveSearchTimeout);this.liveSearchTimeout=setTimeout(jQuery.proxy(function(){this.liveSearchTimeout=null;var m=sap.ui.getCore().getEventBus();m.publish("searchSuggest",{searchTerm:i,activeViews:c.getActiveViews()})},this),200)},this);this.setDisplayBlock(true);if(!jQuery.device.is.desktop){k.setEnableScrolling(false)}else{G.addStyleClass("groupListDesktopScrollbar")}u.updateAggregation=this.updateShellAggregation;d.updateAggregation=this.updateShellAggregation;return new sap.m.App({pages:k})},initNavContainer:function(c){var d=sap.ui.getCore().byId("dashboardPage"),n=new sap.m.NavContainer({id:"navContainer",pages:[d],initialPage:d,afterNavigate:jQuery.proxy(c.onAfterNavigate,c)});n.addCustomTransition("slideBack",sap.m.NavContainer.transitions.slide.back,sap.m.NavContainer.transitions.slide.back);return n},updateShellAggregation:function(n){var b=this.mBindingInfos[n],a=this.getMetadata().getJSONKeys()[n],c;jQuery.each(this[a._sGetter](),jQuery.proxy(function(i,v){this[a._sRemoveMutator](v)},this));jQuery.each(b.binding.getContexts(),jQuery.proxy(function(i,v){c=b.factory(this.getId()+"-"+i,v).setBindingContext(v,b.model);this[a._sMutator](c)},this))},disableBouncing:function(p){p.onBeforeRendering=function(){sap.m.Page.prototype.onBeforeRendering.apply(p);var s=this._oScroller,o=s.onAfterRendering;s.onAfterRendering=function(){o.apply(s);s._scroller.options.bounce=false}};return p},getControllerName:function(){return"sap.ushell.renderers.fiori2.Shell"},pageFactory:function(i,c,d){var p=new sap.m.Page({id:i,showHeader:false,showFooter:false,content:c}),e=["onAfterHide","onAfterShow","onBeforeFirstShow","onBeforeHide","onBeforeShow"],D={};jQuery.each(e,function(I,E){D[E]=jQuery.proxy(function(a){jQuery.each(this.getContent(),function(I,c){c._handleEvent(a)})},p)});p.addEventDelegate(D);if(d){this.disableBouncing(p)}return p},onAfterRendering:function(){if(window.f2p){jQuery.sap.require("sap.ushell.components.perf.monitor");window.f2pMonitor.init(sap.ui.getCore().byId("navContainer"))}}})}());
