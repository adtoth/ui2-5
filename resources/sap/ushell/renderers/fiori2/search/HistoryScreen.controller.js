// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ushell.ui.launchpad.Tile");jQuery.sap.require("sap.ushell.ui.launchpad.TileContainer");jQuery.sap.require("sap.ushell.services.LaunchPage");jQuery.sap.require("sap.ushell.services.Search");jQuery.sap.require("sap.ushell.services.UserRecents");sap.ui.controller("sap.ushell.renderers.fiori2.search.HistoryScreen",{onInit:function(){this.oLaunchPageService=sap.ushell.Container.getService("LaunchPage");this.oUserRecentsService=sap.ushell.services.UserRecents;this.oSearchService=sap.ushell.Container.getService("Search");this.oCurrentSearch=null;var t=this,e=sap.ui.getCore().getEventBus(),r=new sap.ui.model.json.JSONModel();r.setProperty("/apps",[]);r.setProperty("/searches",[]);this.getView().setModel(r);e.subscribe("search",this.newSearchInvoked,this);e.subscribe("searchDataSourceChange",this.newSearchCategory,this);e.subscribe("closeCurtain",this.saveSearch,this);e.subscribe("openApp",this.appOpened,this);e.subscribe("openHistoryScreen",this.updateView,this)},onExit:function(){if(this.oCurrentSearch){this.oUserRecentsService.noticeSearch(this.oCurrentSearch)}var e=sap.ui.getCore().getEventBus();e.unsubscribe("search",this.newSearchInvoked,this);e.unsubscribe("searchDataSourceChange",this.newSearchCategory,this);e.unsubscribe("closeCurtain",this.saveSearch,this);e.unsubscribe("openApp",this.appOpened,this);e.unsubscribe("openHistoryScreen",this.updateView,this)},updateView:function(c,e,d){var u=this.updateAppModel.bind(this),m=this.getView().getModel();this.oUserRecentsService.getRecentApps().done(function(r){u(r)});this.oUserRecentsService.getRecentSearches().done(function(r){jQuery.each(r,function(i,R){var I="/searches/"+i;m.setProperty(I,R)})})},newSearchInvoked:function(c,e,d){if(d.dataSource){this.oCurrentSearch={sTerm:d.searchTerm,oDataSource:d.dataSource}}else{this.oCurrentSearch={sTerm:d.searchTerm,oDataSource:sap.ushell.Container.getService("Search").getDataSource()}}},newSearchCategory:function(c,e,d){if(this.oCurrentSearch){this.oCurrentSearch.oObjectName=d}},saveSearch:function(c,e,d){if(this.oCurrentSearch){this.oUserRecentsService.noticeSearch(this.oCurrentSearch);this.oCurrentSearch=null}},searchAgain:function(e){var s=e.getSource(),S=s.data("sSearchTerm"),d=s.data("oDataSource");sap.ui.getCore().getEventBus().publish("externalSearch",{searchTerm:S,dataSource:d})},appOpened:function(c,e,d){var t=this,n={},r;this.saveSearch(c,e,d);if(!d.semanticObject||!d.action){return}n.semanticObject=d.semanticObject;n.action=d.action;n.sTargetHash=d.sShellHash;this.oSearchService.queryApplicationsByTarget([n],jQuery.proxy(this.storeRecentApp,this,n))},storeRecentApp:function(n,c){if(c&&c.length){this.oUserRecentsService.noticeApp(n)}},updateAppModel:function(r){var m=this.getView().getModel(),b=this.insertTileControl.bind(this,m,r);this.oSearchService.queryApplicationsByTarget(r,function(R){m.setProperty("/apps",[]);jQuery.each(R,b)})},insertTileControl:function(m,s,i,t){m.setProperty("/apps/"+i,t)}})}());
