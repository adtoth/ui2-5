// Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.require("sap.ui.core.IconPool");jQuery.sap.require("sap.m.MessageToast");jQuery.sap.require("sap.m.MessageBox");setTimeout(function(){jQuery.sap.require("sap.ui.thirdparty.datajs");jQuery.sap.require("sap.ushell.renderers.fiori2.launchpad.DashboardManager")},10);jQuery.sap.require("sap.m.Shell");jQuery.sap.require("sap.ushell.components.container.ApplicationContainer");jQuery.sap.require("sap.ushell.services.Message");jQuery.sap.require("sap.ushell.services.ShellNavigation");jQuery.sap.require("sap.ushell.services.AppConfiguration");jQuery.sap.require("sap.ushell.renderers.fiori2.History");jQuery.sap.require("sap.ushell.ui.launchpad.LoadingDialog");var m=new sap.ui.model.json.JSONModel({groups:[],title:"My demo title",searchAvailable:false,searchTerm:"",states:{"home":{"showCurtain":false,"headerHiding":false,"showCatalog":false,"showPane":false,"headItems":["configBtn"],"search":"sf","paneContent":["groupListPage","logoutBtn"]},"app":{"showCurtain":false,"headerHiding":true,"showCatalog":false,"showPane":false,"search":"sf","headItems":["homeBtn"]},"historyScreen":{"showCurtain":true,"headerHiding":false,"showCatalog":false,"search":"sf","curtainContent":["searchHistoryPage"],"paneCurtainContent":["searchFilterPage"]},"searchResults":{"showCurtain":true,"headerHiding":false,"showCatalog":false,"search":"sf","curtainContent":["searchResultPage"],"paneCurtainContent":["searchFilterPage"]},"catalog":{"showCurtain":false,"headerHiding":false,"showCatalog":true,"showPane":false,"search":"sf","headItems":["backBtn"]}}}),c=false;sap.ushell.renderers.fiori2.CONST={CATALOG:{ID:"ShellCatalog",SEMANTICOBJECT:"shell",ACTION:"catalog"},SEARCH:{ID:"ShellSearch",SEMANTICOBJECT:"shell",ACTION:"search"}};m.setSizeLimit(10000);sap.ui.controller("sap.ushell.renderers.fiori2.Shell",{onInit:function(){this.getView().setModel(m);sap.ui.getCore().byId("shellOverlay").setModel(m);this.getView().setModel(sap.ushell.resources.i18nModel,"i18n");sap.ui.getCore().byId("shellOverlay").setModel(sap.ushell.resources.i18nModel,"i18n");sap.ui.getCore().getEventBus().subscribe("externalSearch",this.externalSearchTriggered,this);sap.ui.getCore().getEventBus().subscribe("openCatalog",this.openCatalogByHash,this);sap.ui.getCore().getEventBus().subscribe("openApp",this.openApp,this);this.history=new sap.ushell.renderers.fiori2.History();this.oNavContainer=sap.ui.getCore().byId("navContainer");this.oLoadingDialog=new sap.ushell.ui.launchpad.LoadingDialog({title:null,text:"",showCancelButton:false});sap.ushell.Container.getService("NavTargetResolution").registerCustomResolver({name:"Shell Internal Navigation",isApplicable:jQuery.proxy(this.navTargetIsApplicableForShell,this),resolveHashFragment:jQuery.proxy(this.resolveHashFragmentForShell,this)});sap.ushell.services.ShellNavigation.init(jQuery.proxy(this.doHashChange,this));sap.ushell.services.Message.init(jQuery.proxy(this.doShowMessage,this));try{sap.ushell.Container.getService("Search").isSearchAvailable().done(jQuery.proxy(this.toggleSearch,this))}catch(e){jQuery.sap.log.error(e.name,e.message,"sap.ushell.renderers.fiori2.Shell");jQuery.sap.log.warning("Disabling Search due to errors","","sap.ushell.renderers.fiori2.Shell");this.toggleSearch(false)}},onExit:function(){sap.ui.getCore().getEventBus().unsubscribe("externalSearch",this.externalSearchTriggered,this);sap.ui.getCore().getEventBus().unsubscribe("openCatalog",this.openCatalogByHash,this);sap.ui.getCore().getEventBus().unsubscribe("openApp",this.openApp,this)},getModel:function(){return m},openCatalogByHash:function(C,e,d){window.location="#"+sap.ushell.Container.getService("URLParsing").constructShellHash({target:{semanticObject:sap.ushell.renderers.fiori2.CONST.CATALOG.SEMANTICOBJECT,action:sap.ushell.renderers.fiori2.CONST.CATALOG.ACTION},params:{targetGroup:[(d&&d.groupContext&&d.groupContext.sPath)||"/groups/0"]}})},openCatalog:function(d){if(!sap.ui.getCore().byId("catalogPage")){var p=(d&&d.targetGroup&&d.targetGroup.length&&d.targetGroup[0])||"/groups/0",g=this.getView().getModel().getContext(p);this.oNavContainer.addPage(sap.ui.view({id:"catalogPage",viewName:"sap.ushell.renderers.fiori2.launchpad.catalog.Catalog",viewData:{groupContext:g},type:sap.ui.core.mvc.ViewType.JS}))}this.switchViewState("catalog");this.oNavContainer.to("catalogPage","slide")},openShellOverlay:function(d){var s=sap.ui.getCore().byId("shellOverlay");s.open()},closeShellOverlay:function(){var s=sap.ui.getCore().byId("shellOverlay");if(s.isActive()){c=true;s.close()}},onCurtainClose:function(e){jQuery.sap.log.warning("Closing Curtain",e);var s=sap.ui.getCore().byId("sf");s.$().find("input").blur();sap.ui.getCore().getEventBus().publish("closeCurtain");if(!c){this.switchViewState("/lastState")}c=false},doShowMessage:function(t,M,p){if(t===sap.ushell.services.Message.Type.ERROR){sap.m.MessageBox.show(M,sap.m.MessageBox.Icon.ERROR,p.title||sap.ushell.resources.i18n.getText("error"))}else if(t===sap.ushell.services.Message.Type.CONFIRM){if(p.actions){sap.m.MessageBox.show(M,sap.m.MessageBox.Icon.QUESTION,p.title,p.actions,p.callback)}else{sap.m.MessageBox.confirm(M,p.callback,p.title)}}else{sap.m.MessageToast.show(M,{duration:p.duration||3000})}},doHashChange:function(s,a,o){if(!s){s='#'}if(s.charAt(0)!=='#'){s='#'+s}this.history.hashChange(s,o);if(this.history.getHistoryLength()>1){this.oLoadingDialog.setText("");this.oLoadingDialog.openLoadingScreen()}sap.ushell.Container.getService("NavTargetResolution").resolveHashFragment(s).done(jQuery.proxy(this.openSomething,this,s,o)).fail(jQuery.proxy(function(){this.oLoadingDialog.closeLoadingScreen();sap.ushell.services.Message.error(sap.ushell.resources.i18n.getText("fail_to_start_app"))},this))},openSomething:function(s,o,a){var A;if(!this.oNavContainer.getParent()&&(!a||a.applicationType!=="NWBC")){sap.ui.getCore().byId("shell").addContent(this.oNavContainer)}if(a){try{A=sap.ushell.Container.getService("URLParsing").parseShellHash(s)}catch(e){A=undefined}if(A===undefined){jQuery.sap.log.warning("Could not parse shell hash: "+s);A={}}A.sShellHash=s;A.sOldShellHash=o;A.oApplication=a;sap.ui.getCore().getEventBus().publish("openApp",A)}else{this.openDashboard()}},openDashboard:function(){this.oLoadingDialog.closeLoadingScreen();this.switchViewState("home");this.oNavContainer.backToTop();sap.ushell.services.AppConfiguration.setCurrentApplication(null);this.setAppIcons(null)},openApp:function(C,E,d){jQuery.sap.log.warning("Triggering navigation to ",d);var a,A=d.oApplication,I=null,b=d.sShellHash.replace(/\W/g,"-"),o,s,f;if(A){try{if(A.applicationType===sap.ushell.renderers.fiori2.CONST.CATALOG.ID){this.openCatalog(A);this.oLoadingDialog.closeLoadingScreen();return}if(A.applicationType==="NWBC"){window.history.back(1);if(!jQuery.device.is.desktop){sap.ushell.services.Message.error(sap.ushell.resources.i18n.getText("notAvailableMsg"));return}if(this.history.getHashIndex(d.sShellHash)===0){window.location=A.url}else{window.open(A.url)}this.oLoadingDialog.closeLoadingScreen();return}if(!this.oNavContainer.getPage("application"+b)&&!this.oNavContainer.getPage("shellPage"+b)){a=new sap.ushell.components.container.ApplicationContainer("application"+b,A);sap.ushell.services.AppConfiguration.setCurrentApplication(A);s=sap.ushell.services.AppConfiguration.getMetadata(A).title||"";f=sap.ushell.services.AppConfiguration.getMetadata(A).icon||null;this.oLoadingDialog.showAppInfo(s,f);if(!sap.ushell.services.AppConfiguration.getMetadata(A).fullWidth){I=new sap.m.Shell("shellPage"+b,{title:s,showLogout:false,app:a}).addStyleClass("sapUshellApplicationPage");if(!s){I.addStyleClass("sapUshellApplicationPageNoHdr")}}else{I=a}this.oNavContainer.addPage(I)}this.setAppIcons(sap.ushell.services.AppConfiguration.getMetadata(A));this.switchViewState("app");if(this.history.backwards&&this.oNavContainer.getInitialPage()!==this.oNavContainer.getCurrentPage().getId()){this.oNavContainer.to(I,"slideBack")}else{this.oNavContainer.to(I,this.oNavContainer.getInitialPage()?"slide":"show")}}catch(e){jQuery.sap.log.error(e.name,e.message,(A&&sap.ushell.services.AppConfiguration.getMetadata(A).title)||null);this.oNavContainer.removePage(this.oNavContainer.getCurrentPage()).destroy();o=this.oNavContainer.removeAllPages();this.oNavContainer.destroy();this.oNavContainer=this.getView().initNavContainer(this);jQuery.each(o,jQuery.proxy(function(i,v){if(!this.oNavContainer.getPage(v.getId())){this.oNavContainer.addPage(v)}if(v.getId()===this.oNavContainer.getInitialPage()){v.removeStyleClass("sapMNavItemHidden")}},this));this.navigateToHome();this.oLoadingDialog.closeLoadingScreen();sap.ushell.services.Message.error(sap.ushell.resources.i18n.getText("fail_to_start_app"))}}if(this.history.getHistoryLength()<1){this.oLoadingDialog.closeLoadingScreen()}},setAppIcons:function(M){var l=(M&&M.homeScreenIconPhone)||'../../resources/sap/ushell/themes/base/img/launchicons/57_iPhone_Desktop_Launch.png',L=(M&&M["homeScreenIconPhone@2"])||'../../resources/sap/ushell/themes/base/img/launchicons/114_iPhone-Retina_Web_Clip.png',o=(M&&M.homeScreenIconTablet)||'../../resources/sap/ushell/themes/base/img/launchicons/72_iPad_Desktop_Launch.png',a=(M&&M["homeScreenIconTablet@2"])||'../../resources/sap/ushell/themes/base/img/launchicons/144_iPad_Retina_Web_Clip.png',f=(M&&M.favIcon)||'../../resources/sap/ushell/themes/base/img/launchpad_favicon.ico',t=(M&&M.title)||sap.ushell.resources.i18n.getText("homeBtn_tooltip");jQuery.sap.setIcons({'phone':l,'phone@2':L,'tablet':o,'tablet@2':a,'favicon':f,'precomposed':true});window.document.title=t},externalSearchTriggered:function(C,e,d){m.setProperty("/searchTerm",d.searchTerm);d.query=d.searchTerm;sap.ui.getCore().byId("sfOverlay").fireSearch(d)},onAfterNavigate:function(e){var h=this.oNavContainer.getInitialPage(),f=e.getParameter("fromId");if(f!==h&&f!=="catalogPage"&&f!=="f2p_overview"){this.oNavContainer.removeAggregation("pages",f,true);sap.ui.getCore().byId(f).destroy()}this.oLoadingDialog.closeLoadingScreen()},onAfterRendering:function(){if(window.f2p){f2p.add(f2p.m.endHomePage)}},navigateToHome:function(e){if(location.hash===''){this.openDashboard()}else{location.hash=''}},toggleSearch:function(i){m.setProperty("/searchAvailable",i)},togglePane:function(e){var s=e.getSource(),S=s.getSelected();if(e.getParameter("id")==="categoriesBtn"){s.getModel().setProperty("/currentState/showCurtainPane",!S)}else{s.getModel().setProperty("/currentState/showPane",!S)}},getActiveViews:function(){var C=this.getModel().getProperty("/currentState/curtainContent"),p=sap.ui.getCore().byId(C[0]),a=[];jQuery.each(p.getContent(),function(i,v){a.push(v.getId())});return a},switchViewState:function(s,S){var p=s[0]==="/"?s:"/states/"+s,o=m.getProperty(p),a=sap.ui.getCore().byId("shell"),C=m.getProperty("/currentState")||{};if(!a.getSearch()||o.search!==a.getSearch().getId()){a.setSearch(sap.ui.getCore().byId(o.search))}if(!!S){m.setProperty("/lastState",C)}o=jQuery.extend({},C,o);m.setProperty("/currentState",o);if(!!o.showCurtain){this.openShellOverlay()}else{this.closeShellOverlay()}},navTargetIsApplicableForShell:function(h){var a=sap.ushell.Container.getService("URLParsing").parseShellHash(h.substring(1));return a&&(a.semanticObject===sap.ushell.renderers.fiori2.CONST.CATALOG.SEMANTICOBJECT&&a.action===sap.ushell.renderers.fiori2.CONST.CATALOG.ACTION)},resolveHashFragmentForShell:function(h){var a=sap.ushell.Container.getService("URLParsing").parseShellHash(h.substring(1)),d=new jQuery.Deferred(),r;if(a.action===sap.ushell.renderers.fiori2.CONST.CATALOG.ACTION){r={applicationType:sap.ushell.renderers.fiori2.CONST.CATALOG.ID,catalogSelector:a.params.catalogSelector,tileFilter:a.params.tileFilter,targetGroup:a.params.targetGroup}}d.resolve(r);return d.promise()}})}());
