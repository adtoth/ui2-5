//Copyright (c) 2013 SAP AG, All Rights Reserved
(function(){"use strict";jQuery.sap.declare("sap.ushell.components.factsheet.annotation.Mapping");var c;if(typeof c==="undefined"){c=sap.ushell.components.factsheet}if(!c){c={}}if(!c.annotation){c.annotation={}}c.annotation.Mapping={};c.annotation.Mapping.initialized=[];c.annotation.Mapping.parse=function(m,a){var x={},g,b,s,d,e,r,f,h,n,o,q,A,t={},u,v,S={},i,w,y={},z={},B="",C,D,E,F,G,H,I,T,J,K,L,M,N,j,O,P,Q,R,U,V,W,X,Y,Z,$,_,a1,b1,c1,d1,e1,f1,g1;if(window.ActiveXObject){x={setNameSpace:function(k){k.setProperty("SelectionNamespaces",'xmlns:edmx="http://docs.oasis-open.org/odata/ns/edmx" xmlns:d="http://docs.oasis-open.org/odata/ns/edm"');k.setProperty("SelectionLanguage","XPath");return k},selectNodes:function(k,x,l){return l.selectNodes(x)},nextNode:function(k){return k.nextNode()},getNodeText:function(k){return k.text}}}else{x={setNameSpace:function(k){return k},nsResolver:function(p){var k={"edmx":"http://docs.oasis-open.org/odata/ns/edmx","d":"http://docs.oasis-open.org/odata/ns/edm"};return k[p]||null},selectNodes:function(k,p,l){var h1=k.evaluate(p,l,this.nsResolver,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null);h1.length=h1.snapshotLength;return h1},nextNode:function(k,l){return k.snapshotItem(l)},getNodeText:function(k){return k.textContent}}}g=function(k){var l=jQuery.sap.sjax({url:k});if(l.success){return l.data}};b=function(m){var h1={},i1={},j1={},k1=false,i,l1,m1,n1,o1={},j,p1={},q1={},r1=false,s1,l,k,t1,u1,v1,w1,p,x1;for(i=m.dataServices.schema.length-1;i>=0;i-=1){h1=m.dataServices.schema[i];if(h1.entityType){l1=h1.namespace;m1=h1.entityType;n1=h1.complexType;for(j in m1){o1=m1[j];q1={};if(o1.hasStream&&o1.hasStream==="true"){continue}for(k in o1.property){s1=o1.property[k];if(s1.type.substring(0,l1.length)===l1){for(l in n1){if(n1[l].name===s1.type.substring(l1.length+1)){for(k in n1[l].property){t1=n1[l].property[k];p1[n1[l].name+"/"+t1.name]=t1.type}}}}else{u1=s1.name;v1=s1.type;for(p in s1.extensions){w1=s1.extensions[p];if((w1.name==="display-format")&&(w1.value==="Date")){v1="Edm.Date"}else{r1=true;if(!q1[u1]){q1[u1]={}}if(w1.namespace&&!q1[u1][w1.namespace]){q1[u1][w1.namespace]={}}q1[u1][w1.namespace][w1.name]=w1.value}}p1[u1]=v1}}if(!i1[l1+"."+o1.name]){i1[l1+"."+o1.name]={}}i1[l1+"."+o1.name]=p1;if(r1){if(!j1[l1+"."+o1.name]){k1=true}j1[l1+"."+o1.name]={};j1[l1+"."+o1.name]=q1}}}}if(k1){x1={types:i1,extensions:j1}}else{x1={types:i1}}return x1};s=function(p,k,l,S){var h1,i1,j1='';for(h1 in p){if(p[h1]){i1=p[h1];if(i1.Value&&i1.Value.Path){j1=d(i1.Value.Path,k,l,S);if(j1){p[h1].EdmType=j1}continue}if(i1.Path){j1=d(i1.Path,k,l,S);if(j1){p[h1].EdmType=j1}continue}if(i1.Facets){p[h1].Facets=s(i1.Facets,k,l,S);continue}if(i1.Data){p[h1].Data=s(i1.Data,k,l,S);continue}if(h1==="Data"){p.Data=s(i1,k,l,S);continue}if(i1.Value&&i1.Value.Apply){p[h1].Value.Apply.Parameters=s(i1.Value.Apply.Parameters,k,l,S);continue}if(i1.Value&&i1.Type&&(i1.Type==="Path")){j1=d(i1.Value,k,l,S);if(j1){p[h1].EdmType=j1}}}}return p};d=function(p,k,l,S){var h1;if((p.charAt(0)==="@")&&(p.indexOf(S.Alias)===1)){p=p.slice(S.Alias.length+2)}if(p.indexOf("/")>=0){if(k[p.slice(0,p.indexOf("/"))]){l=p.slice(0,p.indexOf("/"));p=p.slice(p.indexOf("/")+1)}}for(h1 in k[l]){if(p===h1){return k[l][h1]}}};e=function(k){var l="",p="",i,h1={};for(i=0;i<k.attributes.length;i+=1){if((k.attributes[i].name!=="Property")&&(k.attributes[i].name!=="Term")){l=k.attributes[i].name;p=k.attributes[i].value}}if(l.length>0){h1[l]=r(p)}return h1};f=function(u,k){var l={},p,h1,i1,j1,k1,l1;if(k.hasChildNodes()){p=x.selectNodes(u,"./d:String",k);if(p.length>0){h1=x.nextNode(p,0);l["String"]=x.getNodeText(h1)}else{i1=x.selectNodes(u,"./d:Path",k);if(i1.length>0){j1=x.nextNode(i1,0);l["Path"]=x.getNodeText(j1)}else{k1=x.selectNodes(u,"./d:Apply",k);if(k1.length>0){l1=x.nextNode(k1,0);l["Apply"]=o(u,l1)}}}}return l};h=function(u,k,l){var p={},h1,i1,J,j1,k1,l1,m1,n1,o1={},N,O,X,p1,q1;if(k.hasChildNodes()){h1=x.selectNodes(u,"./d:Record | ./d:Collection/d:Record | ./d:Collection/d:If/d:Record",k);if(h1.length){i1=0;for(J=0;J<h1.length;J+=1){j1=x.nextNode(h1,J);k1=n(u,j1,l);if(j1.getAttribute("Type")){k1["RecordType"]=r(j1.getAttribute("Type"))}if(i1===0){if(j1.nextElementSibling||(j1.parentNode.nodeName==="Collection")||(j1.parentNode.nodeName==="If")){p=[];p.push(k1)}else{p=k1}}else{p.push(k1)}i1+=1}}else{l1=x.selectNodes(u,"./d:UrlRef",k);if(l1.length>0){for(J=0;J<l1.length;J+=1){m1=x.nextNode(l1,J);p["UrlRef"]=f(u,m1)}}else{l1=x.selectNodes(u,"./d:Url",k);if(l1.length>0){for(J=0;J<l1.length;J+=1){m1=x.nextNode(l1,J);p["Url"]=f(u,m1)}}else{q1=x.selectNodes(u,"./d:Collection/d:AnnotationPath | ./d:Collection/d:PropertyPath",k);if(q1.length>0){p=[];for(J=0;J<q1.length;J+=1){n1=x.nextNode(q1,J);o1={};o1[n1.nodeName]=n1.textContent;p.push(o1)}}else{p=e(k);N=x.selectNodes(u,"./d:Annotation",k);O={};for(X=0;X<N.length;X+=1){O=x.nextNode(N,X);if(O.hasChildNodes()===false){p1=r(O.getAttribute("Term"));p[p1]=e(O)}}}}}}}else{p=e(k)}return p};n=function(u,k,l){var p={},O={},N,X,h1,i1,J,j1,k1,l1,m1,n1;N=x.selectNodes(u,"./d:Annotation",k);for(X=0;X<N.length;X+=1){O=x.nextNode(N,X);if(O.hasChildNodes()===false){h1=r(O.getAttribute("Term"));p[h1]=e(O)}}i1=x.selectNodes(u,"./d:PropertyValue",k);if(i1.length>0){for(J=0;J<i1.length;J+=1){j1=x.nextNode(i1,J);k1=j1.getAttribute("Property");p[k1]=h(u,j1,l);l1=x.selectNodes(u,"./d:Apply",j1);m1=null;for(n1=0;n1<l1.length;n1+=1){m1=x.nextNode(l1,n1);if(m1){p[k1]={};p[k1]['Apply']=o(u,m1)}}}}else{p=h(u,k,l)}return p};o=function(u,k){var l={},p,h1=null,i1=[],i;p=x.selectNodes(u,"./d:*",k);for(i=0;i<p.length;i+=1){h1=x.nextNode(p,i);switch(h1.nodeName){case"Apply":i1.push({"Type":"Apply","Value":o(u,h1)});break;case"LabeledElement":i1.push({"Name":h1.getAttribute("Name"),"Value":f(u,h1)});break;default:i1.push({"Type":h1.nodeName,"Value":x.getNodeText(h1)});break}}l['Name']=k.getAttribute('Function');l['Parameters']=i1;return l};q=function(l,p,h1){var i1,i,j1,k1,j,k;for(i=m.dataServices.schema.length-1;i>=0;i-=1){i1=m.dataServices.schema[i];if(i1.entityType){j1=i1.namespace+".";k1=i1.entityType;for(k=k1.length-1;k>=0;k-=1){if(j1+k1[k].name===l&&k1[k].navigationProperty){for(j=0;j<k1[k].navigationProperty.length;j+=1){if(k1[k].navigationProperty[j].name===p){return true}}}}}}return false};r=function(k){for(A in y){if(k.indexOf(A+".")>=0){k=k.replace(A+".",y[A]+".");return k}}return k};if(this.initialized[a]){return this.initialized[a]}u=g(a);u=x.setNameSpace(u);v=x.selectNodes(u,"//d:Schema",u);for(i=0;i<v.length;i+=1){w=x.nextNode(v,i);S.Alias=w.getAttribute("Alias");S.Namespace=w.getAttribute("Namespace")}C=x.selectNodes(u,"//edmx:Reference",u);for(i=0;i<C.length;i+=1){D=x.nextNode(C,i);E=x.selectNodes(u,"./edmx:Include",D);if(E&&E.length>0){F=x.nextNode(E,0);if(F.getAttribute("Alias")){y[F.getAttribute("Alias")]=F.getAttribute("Namespace")}else{y[F.getAttribute("Namespace")]=F.getAttribute("Namespace")}}G=x.selectNodes(u,"./edmx:IncludeAnnotations",D);if(G.length>0){for(j=0;j<G.length;j+=1){H=x.nextNode(G,j);if(H.getAttribute("TargetNamespace")){B=H.getAttribute("TargetNamespace");if(!z[B]){z[B]={}}z[B][H.getAttribute("TermNamespace")]=D.getAttribute("Uri")}else{z[H.getAttribute("TermNamespace")]=D.getAttribute("Uri")}}}}if(z){t.annotationReferences=z}t.aliasDefinitions=y;I=x.selectNodes(u,"//d:Term",u);if(I.length>0){T={};for(J=0;J<I.length;J+=1){K=x.nextNode(I,J);L=r(K.getAttribute("Type"));T["@"+S.Alias+"."+K.getAttribute("Name")]=L}t.termDefinitions=T}M=b(m);if(M.extensions){t.propertyExtensions=M.extensions}N=x.selectNodes(u,"//d:Annotations ",u);for(J=0;J<N.length;J+=1){O=x.nextNode(N,J);if(O.hasChildNodes()===false){continue}P=O.getAttribute("Target");Q=P.split(".")[0];if(Q&&y[Q]){P=P.replace(new RegExp(Q,""),y[Q])}R=P;U=null;if(P.indexOf("/")>0){R=P.split("/")[0];U=P.replace(R+"/","")}if(!t[R]){t[R]={}}if(U){if(!t.propertyAnnotations){t.propertyAnnotations={}}if(!t.propertyAnnotations[R]){t.propertyAnnotations[R]={}}t.propertyAnnotations[R][U]={};V=x.selectNodes(u,"./d:Annotation",O);for(X=0;X<V.length;X+=1){W=x.nextNode(V,X);if(W.hasChildNodes()===false){Y=r(W.getAttribute("Term"));t.propertyAnnotations[R][U][Y]=e(W)}}}else{$=R.replace(y[Q],Q);V=x.selectNodes(u,"./d:Annotation",O);for(Z=0;Z<V.length;Z+=1){W=x.nextNode(V,Z);_=W.getAttribute("Qualifier");a1=r(W.getAttribute("Term"));if(_){a1+="#"+_}b1=h(u,W,$);b1=s(b1,M.types,R,S);t[R][a1]=b1}c1=x.selectNodes(u,"//d:Annotations[contains(@Target, '"+$+"')]//d:PropertyValue[contains(@Path, '/')]//@Path",u);for(i=0;i<c1.length;i+=1){d1=x.nextNode(c1,i);e1=d1.value;if(t.propertyAnnotations){if(t.propertyAnnotations[R]){if(t.propertyAnnotations[R][e1]){continue}}}f1=e1.split('/');if(q(R,f1[0],m)){if(!t.expand){t.expand={}}if(!t.expand[R]){t.expand[R]={}}t.expand[R][f1[0]]=f1[0]}}g1=x.selectNodes(u,"//d:Annotations[contains(@Target, '"+$+"')]//d:Path[contains(., '/')]",u);for(i=0;i<g1.length;i+=1){d1=x.nextNode(g1,i);e1=x.getNodeText(d1);if(t.propertyAnnotations[R]){if(t.propertyAnnotations[R][e1]){continue}}if(!t.expand){t.expand={}}if(!t.expand[R]){t.expand[R]={}}f1=e1.split('/');if(q(R,f1[0],m)){if(!t.expand){t.expand={}}if(!t.expand[R]){t.expand[R]={}}t.expand[R][f1[0]]=f1[0]}}}this.initialized[a]=t}return t}}());
